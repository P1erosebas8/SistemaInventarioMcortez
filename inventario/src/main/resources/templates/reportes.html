<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Reportes - Inventario TI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="icon" href="/logo_main.png" type="image/png">
</head>

<body class="d-flex min-vh-100 bg-light">

    <div class="text-white d-flex flex-column flex-shrink-0 p-3" style="width: 250px; background-color: #2a3b8f;">
        <h4 class="text-center mb-4 border-bottom pb-3">
            <i class="bi bi-layers-half"></i> Inventario TI
        </h4>
        <ul class="nav nav-pills flex-column mb-auto">
            <li class="nav-item mb-2"><a href="/panel" class="nav-link text-white"><i
                        class="bi bi-house-door me-2"></i>Inicio</a></li>
            <li class="nav-item mb-2"><a href="/equipos" class="nav-link text-white"><i
                        class="bi bi-laptop me-2"></i>Equipos</a></li>
            <li class="nav-item mb-2"><a href="/usuarios" class="nav-link text-white"><i
                        class="bi bi-people me-2"></i>Usuarios</a></li>
            <li class="nav-item mb-2"><a href="/reportes" class="nav-link active bg-white bg-opacity-25 text-white"><i
                        class="bi bi-bar-chart me-2"></i>Reportes</a></li>
            <li class="nav-item mt-auto">
                <a href="/logout" class="nav-link text-white"><i class="bi bi-box-arrow-left me-2"></i>Cerrar sesiÃ³n</a>
            </li>
        </ul>
    </div>

    <div class="flex-grow-1 overflow-auto">
        <nav class="navbar bg-white shadow-sm px-4 mb-4">
            <span class="navbar-text">
                <h1 class="h4 m-0 text-dark">Reportes y MÃ©tricas</h1>
            </span>
        </nav>

        <div class="container-fluid px-4">

            <div class="row g-4">

                <div class="col-lg-8">

                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header bg-white border-0 pt-4 ps-4">
                            <h5 class="mb-0"><i class="bi bi-pie-chart-fill text-primary"></i> Estado del Inventario
                            </h5>
                        </div>
                        <div class="card-body d-flex justify-content-center" style="height: 350px;">
                            <canvas id="chartEstado"></canvas>
                        </div>
                    </div>

                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white border-0 pt-4 ps-4">
                            <h5 class="mb-0"><i class="bi bi-bar-chart-fill text-success"></i> Usuarios vs Equipos</h5>
                        </div>
                        <div class="card-body" style="height: 250px;">
                            <canvas id="chartComparativo"></canvas>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-header text-white pt-3 ps-3" style="background-color: #25D366;">
                            <h5 class="mb-0"><i class="bi bi-whatsapp"></i> Reportar Incidencia</h5>
                        </div>
                        <div class="card-body p-4">
                            <p class="text-muted small">
                                Completa este formulario para enviar un reporte inmediato a soporte tÃ©cnico vÃ­a
                                WhatsApp.
                            </p>

                            <form id="formWhatsapp" onsubmit="enviarWhatsapp(event)">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Prioridad</label>
                                    <select class="form-select" id="prioridad" required>
                                        <option value="BAJA">ðŸŸ¢ Baja</option>
                                        <option value="MEDIA" selected>ðŸŸ¡ Media</option>
                                        <option value="ALTA">ðŸ”´ Alta</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-bold">DescripciÃ³n del Problema</label>
                                    <textarea class="form-control" id="mensaje" rows="6"
                                        placeholder="Ej: El equipo PC-122 no enciende y huele a quemado..."
                                        required></textarea>
                                </div>

                                <button type="submit" class="btn text-white w-100 fw-bold"
                                    style="background-color: #128C7E;">
                                    <i class="bi bi-send-fill me-2"></i> Enviar a WhatsApp
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script th:inline="javascript">
    
        const cantActivos = [[${ cantActivos }]];
        const cantMalogrados = [[${ cantMalogrados }]];
        const cantReparacion = [[${ cantReparacion }]];
        const cantCambio = [[${ cantCambio }]];

        const totalUsuarios = [[${ totalUsuarios }]];
        const totalEquipos = [[${ totalEquipos }]];

        const ctx1 = document.getElementById('chartEstado').getContext('2d');
        new Chart(ctx1, {
            type: 'doughnut', 
            data: {
                labels: ['Activo', 'Malogrado', 'En ReparaciÃ³n', 'Para Cambio'],
                datasets: [{
                    data: [cantActivos, cantMalogrados, cantReparacion, cantCambio],
                    backgroundColor: [
                        '#198754',
                        '#dc3545',
                        '#ffc107',
                        '#0d6efd' 
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });

        const ctx2 = document.getElementById('chartComparativo').getContext('2d');
        new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: ['Usuarios Registrados', 'Total Equipos'],
                datasets: [{
                    label: 'Cantidad',
                    data: [totalUsuarios, totalEquipos],
                    backgroundColor: ['#2a3b8f', '#6c757d'],
                    borderRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });

        function enviarWhatsapp(event) {
            event.preventDefault(); 

            let prioridad = document.getElementById("prioridad").value;
            let mensaje = document.getElementById("mensaje").value;

            let telefono = "51906769719";

            let textoFinal = `*ðŸš¨ REPORTE DE INCIDENCIA* %0A` +
                `----------------------------- %0A` +
                `*Prioridad:* ${prioridad} %0A` +
                `*Detalle:* ${mensaje}`;

            let url = `https://wa.me/${telefono}?text=${textoFinal}`;

            window.open(url, '_blank');
        }
    </script>

</body>

</html>